<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>è¯å“å…¥åº“</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/layui/css/layui.css" rel="stylesheet">
    <style>
        /* é€‚ç”¨äºChromeã€Safariã€Edgeç­‰WebKitå†…æ ¸æµè§ˆå™¨ */
        ::-webkit-scrollbar {
            display: none;
        }

        /* é€‚ç”¨äºFirefox */
        html {
            scrollbar-width: none;
        }
    </style>
</head>
<body>
<div class="layui-padding-3">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <form class="layui-form layui-form-pane">

                <!--å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯-->
                <div class="layui-card" style="margin-bottom: 16px; border: 1px solid #e2e2e2;">
                    <div class="layui-card-header">ğŸŸª æ“ä½œäººå‘˜ä¿¡æ¯ï¼š</div>
                    <div class="layui-card-body">

                        <div class="layui-form-item layui-col-space10" style="margin-bottom: 0;">

                            <div class="layui-col-md3">
                                <label class="layui-form-label">ç”¨æˆ·å§“åï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" th:value="${session.loginUser.name}" class="layui-input" disabled>
                                </div>
                            </div>

                            <div class="layui-col-md3">
                                <label class="layui-form-label">èº«ä»½è¯å·ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" th:value="${session.loginUser.card}" class="layui-input" disabled>
                                </div>
                            </div>

                            <div class="layui-col-md3">
                                <label class="layui-form-label">è”ç³»ç”µè¯ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" th:value="${session.loginUser.phone}" class="layui-input" disabled>
                                </div>
                            </div>

                            <div class="layui-col-md3">
                                <label class="layui-form-label">èº«ä»½è¯´æ˜ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" th:value="${session.loginUser.other}" class="layui-input" disabled>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>

                <!--ä¾›åº”å•†ä¿¡æ¯-->
                <div class="layui-card" style="margin-bottom: 16px; border: 1px solid #e2e2e2;">
                    <div class="layui-card-header">ğŸŸ¥ ä¾›åº”å•†æˆ·ä¿¡æ¯ï¼š</div>
                    <div class="layui-card-body">

                        <div class="layui-form-item layui-col-space10" style="margin-bottom: 0;">
                            <div class="layui-col-md3">
                                <select lay-search="" lay-filter="vendor-select" lay-verify="required" id="vendor">
                                    <option value="">è¯·é€‰æ‹©æˆ–æœç´¢ä¾›åº”å•†</option>
                                    <option th:each="v : ${vendorList}" th:value="${v.id}" th:text="${v.name}"></option>
                                </select>
                            </div>

                            <div class="layui-col-md3">
                                <label class="layui-form-label">ç”µå­é‚®ç®±ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" class="layui-input" disabled>
                                </div>
                            </div>

                            <div class="layui-col-md3">
                                <label class="layui-form-label">è”ç³»ç”µè¯ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" class="layui-input" disabled>
                                </div>
                            </div>

                            <div class="layui-col-md3">
                                <label class="layui-form-label">è¯¦ç»†åœ°å€ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" class="layui-input" disabled>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>

                <!--ä½¿ç”¨ template æ ‡ç­¾å­˜æ”¾ æ¨¡æ¿è¯å“å…¥åº“ä¿¡æ¯æ¨¡æ¿(å¼€å§‹)-->
                <template id="myTemplate">
                    <br/>
                    <div class="layui-form-item layui-col-space10 layui-anim layui-anim-upbit" style="margin-bottom: 0;">
                        <div class="layui-col-md3">
                            <select lay-search="" lay-filter="medicine-select" lay-verify="required" name="medicineId[]">
                                <option value="">è¯·é€‰æ‹©æˆ–æœç´¢è¯å“ä¿¡æ¯</option>
                                <option th:each="m : ${medicineList}" th:value="${m.id}" th:text="${m.name}"></option>
                            </select>
                        </div>

                        <!--é™æ€æ•°æ®-è‡ªåŠ¨å¡«å……-->
                        <div class="layui-col-md3">
                            <label class="layui-form-label">è¯å“è§„æ ¼ï¼š</label>
                            <div class="layui-input-block">
                                <input type="text" class="layui-input" disabled>
                            </div>
                        </div>

                        <div class="layui-col-md3">
                            <label class="layui-form-label">åŒ…è£…ç…§ç‰‡ï¼š</label>
                            <div class="layui-input-block">
                                <input type="text" class="layui-input" disabled>
                            </div>
                        </div>

                        <div class="layui-col-md3">
                            <label class="layui-form-label">ç”Ÿäº§å‚å®¶ï¼š</label>
                            <div class="layui-input-block">
                                <input type="text" class="layui-input" disabled>
                            </div>
                        </div>

                        <!--åŠ¨æ€æ•°æ®-æ‰‹åŠ¨è¾“å…¥-->
                        <div class="layui-col-md3">
                            <label class="layui-form-label">æœ‰æ•ˆæ—¥æœŸï¼š</label>
                            <div class="layui-input-block">
                                <input type="text" name="birthday[]" autocomplete="off" lay-verify="required" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-col-md3">
                            <label class="layui-form-label">è¯å“æ•°é‡ï¼š</label>
                            <div class="layui-input-block">
                                <input type="number" name="count[]" autocomplete="off" lay-affix="number" lay-verify="required|number" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-col-md3">
                            <label class="layui-form-label">è¯å“å•ä»·ï¼š</label>
                            <div class="layui-input-block">
                                <input type="number" name="price[]" autocomplete="off" lay-affix="number" lay-verify="required" class="layui-input">
                            </div>
                        </div>

                        <div class="layui-col-md3">
                            <label class="layui-form-label">å¤‡æ³¨ä¿¡æ¯ï¼š</label>
                            <div class="layui-input-block">
                                <input type="text" name="other[]" autocomplete="off" lay-verify="required" maxlength="255" class="layui-input">
                            </div>
                        </div>

                    </div>
                </template>
                <!--ä½¿ç”¨ template æ ‡ç­¾å­˜æ”¾ æ¨¡æ¿è¯å“å…¥åº“ä¿¡æ¯æ¨¡æ¿(ç»“æŸ)-->

                <div class="layui-card" style="margin-bottom: 16px; border: 1px solid #e2e2e2;">
                    <div class="layui-card-header">ğŸŸ§ è¯å“å…¥åº“ä¿¡æ¯ï¼š</div>
                    <div class="layui-card-body" id="stockBox">

                        <div class="layui-form-item layui-col-space10" style="margin-bottom: 0;">
                            <div class="layui-col-md3">
                                <select lay-search="" lay-filter="medicine-select" lay-verify="required" name="medicineId[]">
                                    <option value="">è¯·é€‰æ‹©æˆ–æœç´¢è¯å“ä¿¡æ¯</option>
                                    <option th:each="m : ${medicineList}" th:value="${m.id}" th:text="${m.name}"></option>
                                </select>
                            </div>

                            <!--é™æ€æ•°æ®-è‡ªåŠ¨å¡«å……-->
                            <div class="layui-col-md3">
                                <label class="layui-form-label">è¯å“è§„æ ¼ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" class="layui-input" disabled>
                                </div>
                            </div>

                            <div class="layui-col-md3">
                                <label class="layui-form-label">åŒ…è£…ç…§ç‰‡ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" class="layui-input" disabled>
                                </div>
                            </div>

                            <div class="layui-col-md3">
                                <label class="layui-form-label">ç”Ÿäº§å‚å®¶ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" class="layui-input" disabled>
                                </div>
                            </div>

                            <!--åŠ¨æ€æ•°æ®-æ‰‹åŠ¨è¾“å…¥-->
                            <div class="layui-col-md3">
                                <label class="layui-form-label">æœ‰æ•ˆæ—¥æœŸï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" name="birthday[]" autocomplete="off" lay-verify="required" class="layui-input">
                                </div>
                            </div>

                            <div class="layui-col-md3">
                                <label class="layui-form-label">è¯å“æ•°é‡ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="number" name="count[]" lay-affix="number" autocomplete="off" lay-verify="required|number" class="layui-input">
                                </div>
                            </div>

                            <div class="layui-col-md3">
                                <label class="layui-form-label">è¯å“å•ä»·ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="number" name="price[]" lay-affix="number" autocomplete="off" lay-verify="required" class="layui-input">
                                </div>
                            </div>

                            <div class="layui-col-md3">
                                <label class="layui-form-label">å¤‡æ³¨ä¿¡æ¯ï¼š</label>
                                <div class="layui-input-block">
                                    <input type="text" name="other[]" autocomplete="off" lay-verify="required" maxlength="255" class="layui-input">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="layui-panel layui-padding-2 layui-col-md12">
                    <!--åº•éƒ¨æ“ä½œæŒ‰é’®-->
                    <div class="layui-col-md4">
                        <div class="layui-col-md10 layui-col-lg-offset2">
                            <button type="button" class="layui-btn layui-btn-fluid layui-btn-primary layui-border-green layui-anim layui-anim-scaleSpring" lay-on="addStock">æ·»åŠ æ›´å¤šè¯å“å…¥åº“ä¿¡æ¯
                            </button>
                        </div>
                    </div>

                    <div class="layui-col-md4">
                        <div class="layui-col-md10 layui-col-lg-offset1">
                            <button type="button" class="layui-btn layui-btn-fluid layui-btn-primary layui-border-red layui-anim layui-anim-scaleSpring" lay-on="delStock">åˆ é™¤æœ«å°¾è¯å“å…¥åº“ä¿¡æ¯</button>
                        </div>
                    </div>

                    <div class="layui-col-md4">
                        <div class="layui-col-md10">
                            <button class="layui-btn layui-btn-fluid layui-btn-primary layui-border-blue layui-anim layui-anim-scaleSpring" lay-submit lay-filter="toInputStock">æ‰§è¡Œæœ¬æ¬¡è¯å“å…¥åº“æ“ä½œ
                            </button>
                        </div>
                    </div>
                </div>

            </form>

        </div>
    </div>
</div>

<br>
<br>

<script src="/layui/layui.js"></script>
<script>
    layui.use(['form', 'layer', 'jquery', 'util', 'laydate'], function () {
        let form = layui.form;
        let layer = layui.layer;
        let $ = layui.jquery;
        let util = layui.util;
        let laydate = layui.laydate;

        // æ¸²æŸ“æ—¥æœŸç»„ä»¶
        laydate.render({
            elem: 'input[name="birthday[]"]'
        });

        // è‡ªå®šä¹‰éªŒè¯è§„åˆ™
        form.verify({
            number: function (value) {
                if (value > Math.floor(value)) {
                    return 'è¯å“æ•°é‡åº”ä¸ºæ­£æ•´æ•°';
                }
                if (value < 1) {
                    return 'è¯·è¾“å…¥ä¸€ä¸ªæ­£æ•´æ•°';
                }
            }
        });

        // select é€‰ä¸­äº‹ä»¶
        form.on('select(vendor-select)', function (data) {
            let elem = data.elem; // è·å¾— select åŸå§‹ DOM å¯¹è±¡
            let value = data.value; // è·å¾—è¢«é€‰ä¸­çš„å€¼
            $.ajax({
                url: '/getVendorData/' + value,
                type: 'GET',
                success: function (res) {
                    const parentDiv = $(elem).closest('.layui-form-item');
                    parentDiv.find('input:eq(1)').val(res.email);
                    parentDiv.find('input:eq(2)').val(res.phone);
                    parentDiv.find('input:eq(3)').val(res.address);
                },
                error: function (err) {
                    layer.msg('Ajaxè¯·æ±‚å¼‚å¸¸ï¼', {icon: 0});
                }
            });
        });
        // select é€‰ä¸­äº‹ä»¶
        form.on('select(medicine-select)', function (data) {
            let elem = data.elem; // è·å¾— select åŸå§‹ DOM å¯¹è±¡
            let value = data.value; // è·å¾—è¢«é€‰ä¸­çš„å€¼
            $.ajax({
                url: '/getMedicineData/' + value,
                type: 'GET',
                success: function (res) {
                    const parentDiv = $(elem).closest('.layui-form-item');
                    parentDiv.find('input:eq(1)').val(res.specs);
                    parentDiv.find('input:eq(2)').val(res.image);
                    parentDiv.find('input:eq(3)').val(res.origin);
                },
                error: function (err) {
                    layer.msg('Ajaxè¯·æ±‚å¼‚å¸¸ï¼', {icon: 0});
                }
            });
        });

        // è·å–æ¨¡æ¿çš„ç›’å­å®¹å™¨å’Œæ¨¡æ¿
        let stockBox = $('#stockBox');

        // æ·»åŠ åŠåˆ é™¤æ¨¡æ¿æ“ä½œ
        util.on('lay-on', {
            addStock: function () {
                stockBox.append($('#myTemplate').contents().clone());   // è·å–è¯å“å…¥åº“ä¿¡æ¯æ¨¡æ¿å†…å®¹å¹¶å…‹éš†
                form.render();
                laydate.render({
                    elem: 'input[name="birthday[]"]'
                });
            },
            delStock: function () {
                if (stockBox.children().length <= 1) {
                    layer.msg('ä¸èƒ½åˆ é™¤äº†ï¼Œè‡³å°‘åŒ…å«ä¸€ç»„è¯å“å…¥åº“ä¿¡æ¯ï¼')
                } else {
                    stockBox.children().last().add(stockBox.children().last().prev()).remove();
                }
            }
        });

        // æäº¤äº‹ä»¶
        form.on('submit(toInputStock)', function () {

            // éªŒè¯æ“ä½œç”¨æˆ·å¯†ç æ˜¯å¦æ­£ç¡®
            layer.prompt({title: 'è¾“å…¥å½“å‰æ“ä½œç”¨æˆ·çš„å¯†ç è¿›è¡Œèº«ä»½éªŒè¯ï¼', formType: 1}, function (pass, index) {
                layer.close(index);

                $.post('/confirmLoginUserPassword', {password: pass}, function (response) {
                    if (response) {
                        layer.msg('èº«ä»½éªŒè¯é€šè¿‡ï¼', {icon: 6});
                        setTimeout(() => {
                            // æ±‡æ€»è¾“å…¥çš„è¯å“å…¥åº“ä¿¡æ¯é›†åˆ
                            const stockData = [];

                            $('select[name="medicineId[]"]').each(function (index) {
                                const stock = {
                                    what: $(this).val(),
                                    birthday: $('input[name="birthday[]"]').eq(index).val(),
                                    count: $('input[name="count[]"]').eq(index).val(),
                                    price: $('input[name="price[]"]').eq(index).val(),
                                    other: $('input[name="other[]"]').eq(index).val(),
                                    from: $('#vendor').val()
                                }
                                stockData.push(stock);
                            });

                            // è¿›è¡Œæäº¤
                            $.ajax({
                                url: '/doInputStock',
                                type: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify(stockData),
                                success: function (res) {
                                    if (res.code) {
                                        layer.msg('å…¥åº“æˆåŠŸï¼', {icon: 1});
                                        setTimeout(function () {
                                            location.reload();  // å°è¯•ä»ç¼“å­˜ä¸­åŠ è½½é¡µé¢
                                        }, 2000);
                                    } else {
                                        layer.msg('å…¥åº“å¤±è´¥ï¼', {icon: 2});
                                    }
                                },
                                error: function () {
                                    layer.msg('Ajaxè¯·æ±‚å¼‚å¸¸ï¼', {icon: 0});
                                }
                            });
                        }, 2000);
                    } else {
                        layer.msg('èº«ä»½éªŒè¯æœªé€šè¿‡ï¼', {icon: 5});
                        return false; // é˜»æ­¢é»˜è®¤ form è·³è½¬
                    }
                });
            });
            return false; // é˜»æ­¢é»˜è®¤ form è·³è½¬
        });
    });
</script>
</body>
</html>