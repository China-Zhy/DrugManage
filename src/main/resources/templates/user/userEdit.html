<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ç¼–è¾‘ç”¨æˆ·</title>
    <link href="/layui/css/layui.css" rel="stylesheet">
</head>
<body>
<div class="layui-margin-3 layui-anim layui-anim-upbit" style="margin-top: 15px;">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <form class="layui-form layui-form-pane">
                <div class="layui-form-item layui-col-space20">

                    <!--å·¦ä¾§ä¸Šä¼ å¤´åƒ-->
                    <div class="layui-col-md4">
                        <div class="layui-col-md12">
                            <div class="layui-panel" style="aspect-ratio: 1/1;">
                                <img id="ID-upload-demo-img" th:src="${user.base64}" style="width: 100%; height: 100%;">
                                <input type="text" name="base64" id="base64" value="0" hidden="hidden">
                            </div>
                        </div>
                        <div class="layui-col-md12" style="margin-top: 10px;" th:if="${openType==1}">
                            <div class="layui-progress layui-progress-big" lay-showPercent="yes" lay-filter="filter-demo">
                                <div class="layui-progress-bar" lay-percent=""></div>
                            </div>
                        </div>
                        <div class="layui-col-md12" style="margin-top: 10px;" th:if="${openType==1}">
                            <button type="button" class="layui-btn layui-btn-normal layui-btn-sm layui-btn-fluid" id="ID-upload-demo-btn">
                                <i class="layui-icon layui-icon-upload"></i> ä¸Šä¼ ç”¨æˆ·ç…§ç‰‡
                            </button>
                        </div>
                        <div id="ID-upload-demo-text" class="layui-col-md12" style="margin-top: 10px;" th:if="${openType==1}"></div>
                    </div>

                    <!--å³ä¾§åŸºæœ¬ä¿¡æ¯-->
                    <div class="layui-col-md4">
                        <label class="layui-form-label">ç”¨æˆ·å§“åï¼š</label>
                        <div class="layui-input-block">
                            <input type="text" name="name" th:value="${user.name}" autocomplete="off" class="layui-input" lay-verify="required" th:disabled="${openType==2}">
                        </div>
                    </div>

                    <div class="layui-col-md4">
                        <label class="layui-form-label">æ‰‹æœºå·ç ï¼š</label>
                        <div class="layui-input-block">
                            <input type="text" name="phone" th:value="${user.phone}" autocomplete="off" class="layui-input" lay-verify="required|phone" th:disabled="${openType==2}">
                        </div>
                    </div>

                    <div class="layui-col-md4">
                        <label class="layui-form-label">èº«ä»½è¯å·ï¼š</label>
                        <div class="layui-input-block">
                            <input type="text" name="card" th:value="${user.card}" id="card" autocomplete="off" class="layui-input" lay-verify="required|identity" th:disabled="${openType==2}">
                        </div>
                    </div>

                    <div class="layui-col-md4">
                        <label class="layui-form-label">è´¦å·å¯†ç ï¼š</label>
                        <div class="layui-input-block">
                            <input type="password" name="password" th:value="${user.password}" id="password" class="layui-input" th:disabled="${openType==2}">
                        </div>
                    </div>

                    <div class="layui-col-md4">
                        <label class="layui-form-label">ç”¨æˆ·èº«ä»½ï¼š</label>
                        <div class="layui-input-block">
                            <select name="type" lay-verify="required" th:disabled="${openType==2}">
                                <option th:each="i : ${identityList}" th:value="${i.id}" th:text="${i.name}" th:selected="${i.id == user.type}"></option>
                            </select>
                        </div>
                    </div>

                    <div class="layui-col-md4">
                        <label class="layui-form-label">è´¦å·çŠ¶æ€ï¼š</label>
                        <div class="layui-input-block">
                            <select name="status" th:disabled="${openType==2}">
                                <option value="1" th:selected="${user.status == 1}">å¯ç”¨</option>
                                <option value="2" th:selected="${user.status == 2}">åœç”¨</option>
                            </select>
                        </div>
                    </div>

                    <div class="layui-col-md8">
                        <label class="layui-form-label">å±…ä½åœ°å€ï¼š</label>
                        <div class="layui-input-inline">
                            <select id="quiz1" lay-verify="required" lay-filter="quiz1" th:disabled="${openType==2}">
                                <option value="">è¯·é€‰æ‹©çœ</option>
                                <option th:each="a : ${area1List}" th:value="${a.code}" th:text="${a.name}" th:selected="${a.code == code1}"></option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select id="quiz2" lay-verify="required" lay-filter="quiz2" th:disabled="${openType==2}">
                                <option value="">è¯·é€‰æ‹©å¸‚</option>
                                <option th:each="a : ${area2List}" th:value="${a.code}" th:text="${a.name}" th:selected="${a.code == code2}"></option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select id="quiz3" lay-verify="required" lay-filter="quiz3" th:disabled="${openType==2}">
                                <option value="">è¯·é€‰æ‹©å¿/åŒº</option>
                                <option th:each="a : ${area3List}" th:value="${a.code}" th:text="${a.name}" th:selected="${a.code == code3}"></option>
                            </select>
                        </div>
                        <div class="layui-form-mid layui-text-em">*è¯·æŒ‰å½“å‰å±…ä½åœ°å€å¡«å†™</div>
                    </div>

                    <div class="layui-col-md8">
                        <label class="layui-form-label">è¯¦ç»†ä½ç½®ï¼š</label>
                        <div class="layui-input-block">
                            <input type="text" id="quiz4" th:value="${user.address}" autocomplete="off" class="layui-input" lay-verify="required" th:disabled="${openType==2}">
                        </div>
                    </div>
                    <input type="text" name="address" id="address" hidden="hidden">

                    <div class="layui-col-md8 layui-form-text">
                        <label class="layui-form-label">å…¶ä»–ä¿¡æ¯ï¼š</label>
                        <div class="layui-input-block">
                            <textarea name="other" th:text="${user.other}" class="layui-textarea" lay-verify="required" maxlength="500" rows="10" th:disabled="${openType==2}"></textarea>
                        </div>
                    </div>
                </div>

                <hr th:if="${openType==2}"/>

                <!--ç”¨æˆ·ç¼–å·-->
                <input type="text" name="id" th:value="${user.id}" hidden="hidden">

                <div class="layui-form-item layui-col-space20" th:if="${openType==1}">
                    <div class="layui-col-md12" style="text-align: center;">
                        <button class="layui-btn layui-btn-danger" lay-submit lay-filter="toSet">æ›´æ–°ç”¨æˆ·ä¿¡æ¯</button>
                        <button type="reset" class="layui-btn layui-btn-warm">æ¢å¤åŸå§‹ä¿¡æ¯</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="/layui/layui.js"></script>
<script>
    layui.use(['form', 'layer', 'jquery', 'upload', 'element'], function () {
        let form = layui.form;
        let layer = layui.layer;
        let $ = layui.jquery;
        let upload = layui.upload;
        let element = layui.element;

        let imageIsOk = true;

        // å•å›¾ç‰‡ä¸Šä¼ 
        let uploadInst = upload.render({
            elem: '#ID-upload-demo-btn',
            url: '/uploadImage',
            size: 512, // é™åˆ¶æ–‡ä»¶å¤§å°ï¼Œå•ä½KB
            before: function (obj) {
                // é¢„è¯»æœ¬åœ°æ–‡ä»¶ç¤ºä¾‹ï¼Œä¸æ”¯æŒie8
                obj.preview(function (index, file, result) {
                    $('#ID-upload-demo-img').attr('src', result); // å›¾ç‰‡é“¾æ¥ï¼ˆbase64ï¼‰
                });
                element.progress('filter-demo', '0%'); // è¿›åº¦æ¡å¤ä½
            },
            done: function (res) {
                if (res === 0) {
                    imageIsOk = false;
                    return layer.msg('ä¸Šä¼ å¤±è´¥ï¼');
                }
                layer.msg('ä¸Šä¼ æˆåŠŸï¼')
                $('#ID-upload-demo-text').html('ä¸Šä¼ æˆåŠŸğŸ˜€');
                $('#base64').val('1');    // è¡¨ç¤ºç”¨æˆ·å¤´åƒé‡æ–°ä¸Šä¼ äº†
            },
            error: function () {
                // æ¼”ç¤ºå¤±è´¥çŠ¶æ€ï¼Œå¹¶å®ç°é‡ä¼ 
                let demoText = $('#ID-upload-demo-text');
                demoText.html('<span style="color: #FF5722;">ä¸Šä¼ å¤±è´¥ğŸ˜¥</span>&ensp;<a class="layui-btn layui-bg-purple layui-btn-xs demo-reload">ç‚¹æˆ‘é‡è¯•</a>');
                demoText.find('.demo-reload').on('click', function () {
                    uploadInst.upload();
                });
            },
            // è¿›åº¦æ¡
            progress: function (n, elem, e) {
                element.progress('filter-demo', n + '%'); // å¯é…åˆ layui è¿›åº¦æ¡å…ƒç´ ä½¿ç”¨
            }
        });

        // æˆªå–èº«ä»½è¯å·å6ä½ä½œä¸ºå¯†ç 
        $('#card').on('input', function () {
            $('#password').val($(this).val().slice(-6));
        });

        // ç›‘å¬ä¸€çº§é€‰æ‹©äº‹ä»¶
        form.on('select(quiz1)', function (data) {
            let quiz1 = data.value;
            if (quiz1) {
                // æ¸…ç©ºå¸‚å’Œå¿/åŒºçš„é€‰æ‹©æ¡†
                $('#quiz2').html('<option value="">è¯·é€‰æ‹©å¸‚</option>');
                $('#quiz3').html('<option value="">è¯·é€‰æ‹©å¿/åŒº</option>');
                form.render('select');

                // è¯·æ±‚äºŒçº§åˆ—è¡¨
                $.get('/getArea/2/' + quiz1, function (data) {
                    $.each(data, function (index, info) {
                        $('#quiz2').append('<option value="' + info.code + '">' + info.name + '</option>');
                    });
                    form.render('select');
                }).fail(function () {
                    layer.msg('è¯·æ±‚äºŒçº§åˆ—è¡¨å¤±è´¥ï¼', {icon: 2});
                });
            }
        });

        // ç›‘å¬äºŒçº§é€‰æ‹©äº‹ä»¶
        form.on('select(quiz2)', function (data) {
            let quiz2 = data.value;
            if (quiz2) {
                // æ¸…ç©ºå¿åŒºé€‰æ‹©æ¡†
                $('#quiz3').html('<option value="">è¯·é€‰æ‹©å¿/åŒº</option>');
                form.render('select');

                // è¯·æ±‚å¿åŒºåˆ—è¡¨
                $.get('/getArea/3/' + quiz2, function (data) {
                    $.each(data, function (index, info) {
                        $('#quiz3').append('<option value="' + info.code + '">' + info.name + '</option>');
                    });
                    form.render('select');
                }).fail(function () {
                    layer.msg('è¯·æ±‚ä¸‰çº§åˆ—è¡¨å¤±è´¥ï¼', {icon: 2});
                });
            }
        });

        // æ‹¼æ¥è¯¦ç»†åœ°å€
        function splicingAddress() {
            let code = $('#quiz1').val() + '/' + $('#quiz2').val() + '/' + $('#quiz3').val();
            let address = $('#quiz1 option:selected').text() + $('#quiz2 option:selected').text() + $('#quiz3 option:selected').text() + '-' + $('#quiz4').val();
            $('#address').val(code + '/' + address);
        }

        // ç›‘å¬ä¸‰çº§é€‰æ‹©äº‹ä»¶
        form.on('select(quiz3)', function () {
            splicingAddress();
        });

        // ç›‘å¬è¯¦ç»†åœ°å€çš„è¾“å…¥äº‹ä»¶
        $('#quiz4').on('input', function () {
            splicingAddress();
        });

        // æœ€ç»ˆè¡¨å•æäº¤äº‹ä»¶
        form.on('submit(toSet)', function (data) {

            if (!imageIsOk) {
                layer.msg('è¯·ä¸Šä¼ ç”¨æˆ·å¤´åƒï¼', {icon: 0});
                return false; // é˜»æ­¢é»˜è®¤ form è·³è½¬
            }

            let field = data.field; // è·å–è¡¨å•å­—æ®µå€¼

            $.ajax({
                url: '/doUserSet',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(field),
                success: function (res) {
                    if (res.code === 1) {
                        layer.msg('æ›´æ–°æˆåŠŸï¼', {icon: 1});

                        $.each(res.info, function (key, value) {
                            // åˆ¤æ–­å€¼æ˜¯å¦ä¸ºç©ºï¼ˆnullã€undefinedã€ç©ºå­—ç¬¦ä¸²ã€ç©ºæ•°ç»„ã€ç©ºå¯¹è±¡ï¼‰
                            if (value === null || value === undefined || value === '' ||
                                (Array.isArray(value) && value.length === 0) ||
                                (typeof value === 'object' && !Array.isArray(value) && Object.keys(value).length === 0)) {
                                delete res.info[key]; // åˆ é™¤ç©ºå€¼å±æ€§
                            }
                        });

                        // é€šè¿‡window.parentè®¿é—®çˆ¶é¡µé¢çš„å…¨å±€å˜é‡å¹¶ä¿®æ”¹
                        window.parent.parentData = res.info;

                        setTimeout(function () {
                            parent.layer.close(parent.layer.getFrameIndex(window.name));    // å…³é—­å¼¹å‡ºå±‚
                        }, 2000);
                    } else {
                        layer.msg('æ›´æ–°å¤±è´¥ï¼', {icon: 2});
                        imageIsOk = false;
                    }
                },
                error: function () {
                    layer.msg('Ajaxè¯·æ±‚å¼‚å¸¸ï¼', {icon: 0});
                }
            });
            return false; // é˜»æ­¢é»˜è®¤ form è·³è½¬
        });
    });
</script>
</body>
</html>