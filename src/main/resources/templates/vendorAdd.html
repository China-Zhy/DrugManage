<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>添加供应商</title>
    <link href="/layui/css/layui.css" rel="stylesheet">
</head>
<body>
<div class="layui-padding-2" style="margin-top: 15px;">
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <form class="layui-form layui-form-pane">
                <div class="layui-form-item layui-col-space20">
                    <div class="layui-col-md6">
                        <label class="layui-form-label">供应商名称</label>
                        <div class="layui-input-block">
                            <input type="text" name="name" autocomplete="off" class="layui-input" lay-verify="required">
                        </div>
                    </div>

                    <div class="layui-col-md6">
                        <select lay-search="" lay-filter="medicine-select" lay-verify="required" name="people">
                            <option value="">请选择或搜索法定代表人</option>
                            <option th:each="v : ${vendorUserList}" th:value="${v.id}" th:text="|${v.name} - ${v.phone}|"></option>
                        </select>
                    </div>

                    <div class="layui-col-md12">
                        <label class="layui-form-label">公司地址</label>
                        <div class="layui-input-inline">
                            <select id="quiz1" lay-verify="required" lay-filter="quiz1">
                                <option value="">请选择省</option>
                                <option th:each="a : ${areaList}" th:value="${a.code}" th:text="${a.name}"></option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select id="quiz2" lay-verify="required" lay-filter="quiz2">
                                <option value="">请选择市</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select id="quiz3" lay-verify="required">
                                <option value="">请选择县/区</option>
                            </select>
                        </div>
                        <div class="layui-form-mid layui-text-em">*请按当前公司所在地址填写</div>
                    </div>

                    <div class="layui-col-md6">
                        <label class="layui-form-label">详细地址</label>
                        <div class="layui-input-block">
                            <input type="text" id="quiz4" autocomplete="off" class="layui-input" lay-verify="required">
                        </div>
                    </div>
                    <input type="text" name="address" id="address" hidden="hidden">

                    <div class="layui-col-md6">
                        <label class="layui-form-label">营业执照</label>
                        <div class="layui-input-block">
                            <input type="text" name="code" autocomplete="off" class="layui-input" lay-verify="required">
                        </div>
                    </div>

                    <div class="layui-col-md6">
                        <label class="layui-form-label">联系电话</label>
                        <div class="layui-input-block">
                            <input type="text" name="phone" autocomplete="off" class="layui-input" lay-verify="required|phone">
                        </div>
                    </div>

                    <div class="layui-col-md6">
                        <label class="layui-form-label">电子邮箱</label>
                        <div class="layui-input-block">
                            <input type="text" name="email" autocomplete="off" class="layui-input" lay-verify="required|email">
                        </div>
                    </div>

                    <div class="layui-col-md6">
                        <label class="layui-form-label">邮政编码</label>
                        <div class="layui-input-block">
                            <input type="number" name="postcode" autocomplete="off" class="layui-input" lay-verify="required|number" maxlength="6">
                        </div>
                    </div>

                    <div class="layui-col-md6">
                        <label class="layui-form-label">开户银行</label>
                        <div class="layui-input-block">
                            <input type="text" name="bank" autocomplete="off" class="layui-input" lay-verify="required">
                        </div>
                    </div>

                    <div class="layui-col-md6">
                        <label class="layui-form-label">银行账户</label>
                        <div class="layui-input-block">
                            <input type="number" name="account" autocomplete="off" class="layui-input" lay-verify="required|number">
                        </div>
                    </div>

                    <div class="layui-col-md6">
                        <label class="layui-form-label">状态信息</label>
                        <div class="layui-input-block">
                            <select name="status" lay-verify="required">
                                <option value="1" selected>可用</option>
                                <option value="2">停用</option>
                            </select>
                        </div>
                    </div>

                </div>

                <div class="layui-form-item layui-col-space20">
                    <div class="layui-col-md12" style="text-align: center;">
                        <button class="layui-btn layui-bg-purple" lay-submit lay-filter="toDo">添加</button>
                        <button type="reset" class="layui-btn layui-btn-primary">清空</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="/layui/layui.js"></script>
<script>
    layui.use(['form', 'layer', 'jquery'], function () {
        let form = layui.form;
        let layer = layui.layer;
        let $ = layui.jquery;

        // 监听一级选择事件
        form.on('select(quiz1)', function (data) {
            let quiz1 = data.value;
            if (quiz1) {
                // 清空市和县/区的选择框
                $('#quiz2').html('<option value="">请选择市</option>');
                $('#quiz3').html('<option value="">请选择县/区</option>');
                form.render('select');

                // 请求二级列表
                $.get('/getArea/2/' + quiz1, function (data) {
                    let quiz2Select = $('#quiz2');
                    $.each(data, function (index, info) {
                        quiz2Select.append('<option value="' + info.code + '">' + info.name + '</option>');
                    });
                    form.render('select');
                }).fail(function () {
                    layer.msg('请求二级列表失败！', {icon: 2});
                });
            }
        });

        // 监听二级选择事件
        form.on('select(quiz2)', function (data) {
            let quiz2 = data.value;
            if (quiz2) {
                // 清空县区选择框
                $('#quiz3').html('<option value="">请选择县/区</option>');
                form.render('select');

                // 请求县区列表
                $.get('/getArea/3/' + quiz2, function (data) {
                    let quiz3Select = $('#quiz3');
                    $.each(data, function (index, info) {
                        quiz3Select.append('<option value="' + info.fullName + '">' + info.name + '</option>');
                    });
                    form.render('select');
                }).fail(function () {
                    layer.msg('请求三级列表失败！', {icon: 2});
                });
            }
        });

        // 拼接详细地址
        $('#quiz3, #quiz4').on('change input', function () {
            $('#address').val($('#quiz3').val() + '-' + $('#quiz4').val());
        });

        // 提交事件
        form.on('submit(toDo)', function (data) {
            let field = data.field; // 获取表单字段值

            $.ajax({
                url: '/doAddVendor',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(field),
                success: function (res) {
                    if (res.code) {
                        layer.msg('添加成功！', {icon: 1});
                        setTimeout(function () {
                            parent.layer.close(parent.layer.getFrameIndex(window.name));    // 关闭弹出层
                        }, 2000);
                    } else {
                        layer.msg('添加失败！', {icon: 2});
                    }
                },
                error: function () {
                    layer.msg('Ajax请求异常！', {icon: 0});
                }
            });
            return false; // 阻止默认 form 跳转
        });
    });
</script>
</body>
</html>